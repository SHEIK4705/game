<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🌲 Forest Quest — Level Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Quicksand:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --g1: #052e2b;
        --g2: #0b4a3e;
        --g3: #116a54;
        --acc: #34d399;
        --acc2: #a7f3d0;
      }
      html,
      body {
        height: 100%;
      }
      body {
        background: url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1974&auto=format&fit=crop")
          no-repeat center center/cover;
        font-family: "Quicksand", sans-serif;
        color: #ecfdf5;
        overflow-x: hidden;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.65),
          rgba(0, 0, 0, 0.55)
        );
        backdrop-filter: blur(3px);
        z-index: 0;
      }
      .glass {
        background: rgba(6, 78, 59, 0.85);
        border: 2px solid rgba(16, 185, 129, 0.45);
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      }
      .btn {
        background: linear-gradient(145deg, var(--acc), #059669);
        padding: 0.75rem 1.25rem;
        border-radius: 0.85rem;
        font-weight: 700;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .btn:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
      }
      .btn-ghost {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .title {
        font-family: "Press Start 2P", cursive;
        text-shadow: 0 0 10px #10b981;
      }
      .chip {
        background: rgba(20, 83, 45, 0.6);
        border: 1px solid rgba(167, 243, 208, 0.35);
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
      }
      .option {
        background: rgba(15, 63, 49, 0.85);
        border: 1px solid rgba(52, 211, 153, 0.35);
        border-radius: 0.85rem;
        padding: 0.85rem 1rem;
        cursor: pointer;
        transition: 0.15s;
      }
      .option:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.25);
      }
      .disabled {
        opacity: 0.55;
        pointer-events: none;
      }
      .shake {
        animation: shake 0.25s linear 1;
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-4px);
        }
        100% {
          transform: translateX(0);
        }
      }
      .fireflies {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
      }
      .dot {
        position: absolute;
        width: 3px;
        height: 3px;
        border-radius: 999px;
        background: radial-gradient(
          circle,
          #d1fae5 0,
          #34d399 60%,
          transparent 70%
        );
        opacity: 0.9;
        animation: fly 7s linear infinite;
      }
      @keyframes fly {
        0% {
          transform: translate(0, 0) scale(1);
        }
        50% {
          transform: translate(40px, -60px) scale(1.3);
        }
        100% {
          transform: translate(-20px, 30px) scale(1);
        }
      }
      input[type="text"],
      textarea {
        color: #06281f;
        background: #ecfdf5;
      }
      .meter {
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.15);
        overflow: hidden;
      }
      .meter > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 0.25s;
      }
      .kbd {
        background: #083b2e;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom-width: 3px;
        border-radius: 0.5rem;
        padding: 0.15rem 0.45rem;
        font-weight: 700;
      }
      .sr {
        position: absolute;
        left: -9999px;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <div class="overlay"></div>

    <div class="fireflies" id="fx"></div>

    <header class="relative z-10 text-center py-6 px-4">
      <h1 class="title text-2xl md:text-3xl text-green-200">
        Forest Quest — Level <span id="lvlT">1</span>
      </h1>
      <div
        class="mt-3 flex items-center justify-center gap-3 text-sm text-green-100"
      >
        <span class="chip">Region: Forest</span>
        <span class="chip">XP: <span id="xpNow">0</span></span>
        <span class="chip">Question: <span id="qNow">1</span>/10</span>
        <span class="chip">Tries Left: <span id="tries">3</span></span>
      </div>
    </header>

    <main
      class="relative z-10 flex-1 flex items-center justify-center px-4 pb-10"
    >
      <div class="glass w-full max-w-3xl p-5 md:p-8">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div class="meter w-1/2">
            <span id="bar" style="width: 0%"></span>
          </div>
          <div class="text-xs md:text-sm text-green-200">
            Goal: <span id="goalXp">30</span> XP
          </div>
        </div>

        <div id="scene" class="space-y-5">
          <div
            id="prompt"
            class="text-lg md:text-xl font-bold text-green-100 leading-relaxed"
          ></div>
          <div id="sub" class="text-sm md:text-base text-green-200"></div>
          <div id="ui" class="mt-1"></div>
          <div id="note" class="text-xs text-green-200/90"></div>
        </div>

        <div class="mt-7 flex flex-wrap items-center justify-between gap-3">
          <button id="submitBtn" class="btn disabled" disabled>
            <span>Submit</span>
          </button>
          <div class="flex items-center gap-2 text-sm">
            <span class="kbd">Enter</span> submit
            <span class="mx-1 opacity-50">•</span>
            <span class="kbd">Tab</span> next
          </div>
        </div>
      </div>
    </main>

    <div class="relative z-10 text-center text-green-200 text-xs pb-6 px-4">
      © 2025 Forest Quest
    </div>

    <script>
      const PROFILE_KEY = "fqx_forest_profile_v1";
      const qs = new URLSearchParams(location.search);
      const level = Math.min(
        Math.max(parseInt(qs.get("level") || "1", 10), 1),
        10
      );
      const perQuestionXP = level === 10 ? 5 : 3;
      const TOTAL_Q = 10;
      const GOAL_XP = level === 10 ? 50 : 30;
      const THRESHOLD_TO_UNLOCK = 35;
      let current = 0,
        score = 0,
        tries = 3,
        answered = false,
        selected = null,
        inputRef = null,
        lock = false;

      document.getElementById("lvlT").textContent = level;
      document.getElementById("goalXp").textContent = GOAL_XP;
      document.getElementById("xpNow").textContent = score;
      document.getElementById("qNow").textContent = current + 1;
      document.getElementById("tries").textContent = tries;

      function spawnFireflies(n = 35) {
        const fx = document.getElementById("fx");
        for (let i = 0; i < n; i++) {
          const d = document.createElement("div");
          d.className = "dot";
          d.style.left = Math.random() * 100 + "%";
          d.style.top = Math.random() * 100 + "%";
          d.style.animationDelay = Math.random() * 7 + "s";
          d.style.opacity = (0.6 + Math.random() * 0.4).toFixed(2);
          fx.appendChild(d);
        }
      }
      spawnFireflies();

      function loadProfile() {
        let raw = localStorage.getItem(PROFILE_KEY);
        let profile = {
          perLevelBest: Array(10).fill(0),
          valleyUnlocked: false,
        };
        if (raw) {
          try {
            profile = JSON.parse(raw);
          } catch (e) {}
        }
        // Check valley profile for valleyUnlocked
        let valleyRaw = localStorage.getItem("fqx_progress_valley_v1");
        if (valleyRaw) {
          try {
            let valleyProfile = JSON.parse(valleyRaw);
            profile.valleyUnlocked = valleyProfile.valleyUnlocked || false;
          } catch (e) {}
        }
        return profile;
      }
      function saveProfile(p) {
        localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
      }

      function shuffle(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      const L1 = [
        // Word Hunt (MCQ choose the word that appears in the hidden forest grid hint)
        {
          q: "Word Hunt: Hidden among leaves — find the forest-related word.",
          hint: "MOSS  ·  BOAT  ·  CLOUD",
          type: "mcq",
          opts: ["Moss", "Boat", "Cloud"],
          ans: "Moss",
        },
        {
          q: "Word Hunt: Choose the word you’d see in a forest.",
          hint: "TRAIL  ·  TAXI  ·  LASER",
          type: "mcq",
          opts: ["Trail", "Taxi", "Laser"],
          ans: "Trail",
        },
        {
          q: "Word Hunt: Which one belongs to forest life?",
          hint: "ACORN  ·  ENGINE  ·  MOUSE",
          type: "mcq",
          opts: ["Acorn", "Engine", "Mouse"],
          ans: "Acorn",
        },
        {
          q: "Word Hunt: Pick the hiding word.",
          hint: "FERN  ·  CABLE  ·  BRICK",
          type: "mcq",
          opts: ["Fern", "Cable", "Brick"],
          ans: "Fern",
        },
        {
          q: "Word Hunt: Which word is part of trees?",
          hint: "BARK  ·  WHEEL  ·  BRIDGE",
          type: "mcq",
          opts: ["Bark", "Wheel", "Bridge"],
          ans: "Bark",
        },
        {
          q: "Word Hunt: Choose the natural one.",
          hint: "STREAM  ·  ROBOT  ·  SOCKET",
          type: "mcq",
          opts: ["Stream", "Robot", "Socket"],
          ans: "Stream",
        },
        {
          q: "Word Hunt: Look close in the canopy.",
          hint: "VINE  ·  TUNNEL  ·  ROCKET",
          type: "mcq",
          opts: ["Vine", "Tunnel", "Rocket"],
          ans: "Vine",
        },
        {
          q: "Word Hunt: Pick the animal trail sign.",
          hint: "PAWPRINT  ·  KEYBOARD  ·  STAPLE",
          type: "mcq",
          opts: ["Pawprint", "Keyboard", "Staple"],
          ans: "Pawprint",
        },
        {
          q: "Word Hunt: Which is a forest sound?",
          hint: "RUSTLE  ·  HORN  ·  CLAXON",
          type: "mcq",
          opts: ["Rustle", "Horn", "Claxon"],
          ans: "Rustle",
        },
        {
          q: "Word Hunt: Under the roots lies…",
          hint: "MUSHROOM  ·  LIFT  ·  ELEVATOR",
          type: "mcq",
          opts: ["Mushroom", "Lift", "Elevator"],
          ans: "Mushroom",
        },
      ];
      const L2 = [
        // Synonym Trail
        {
          q: "Synonym of calm (forest at dusk):",
          type: "mcq",
          opts: ["Serene", "Noisy", "Wild"],
          ans: "Serene",
        },
        {
          q: "Synonym of path:",
          type: "mcq",
          opts: ["Trail", "Wall", "Ceiling"],
          ans: "Trail",
        },
        {
          q: "Synonym of protect:",
          type: "mcq",
          opts: ["Guard", "Harm", "Ignore"],
          ans: "Guard",
        },
        {
          q: "Synonym of bright:",
          type: "mcq",
          opts: ["Luminous", "Dull", "Hidden"],
          ans: "Luminous",
        },
        {
          q: "Synonym of small:",
          type: "mcq",
          opts: ["Tiny", "Huge", "Vast"],
          ans: "Tiny",
        },
        {
          q: "Synonym of begin:",
          type: "mcq",
          opts: ["Start", "Finish", "Delay"],
          ans: "Start",
        },
        {
          q: "Synonym of tired:",
          type: "mcq",
          opts: ["Weary", "Brisk", "Alert"],
          ans: "Weary",
        },
        {
          q: "Synonym of smell:",
          type: "mcq",
          opts: ["Scent", "Taste", "Sight"],
          ans: "Scent",
        },
        {
          q: "Synonym of danger:",
          type: "mcq",
          opts: ["Peril", "Rescue", "Safety"],
          ans: "Peril",
        },
        {
          q: "Synonym of guide:",
          type: "mcq",
          opts: ["Lead", "Follow", "Stray"],
          ans: "Lead",
        },
      ];
      const L3 = [
        // Antonym Quest
        {
          q: "Antonym of wild:",
          type: "mcq",
          opts: ["Tame", "Fierce", "Savage"],
          ans: "Tame",
        },
        {
          q: "Antonym of dark:",
          type: "mcq",
          opts: ["Bright", "Dim", "Deeper"],
          ans: "Bright",
        },
        {
          q: "Antonym of noisy:",
          type: "mcq",
          opts: ["Quiet", "Loud", "Boisterous"],
          ans: "Quiet",
        },
        {
          q: "Antonym of humid:",
          type: "mcq",
          opts: ["Dry", "Sticky", "Damp"],
          ans: "Dry",
        },
        {
          q: "Antonym of safe:",
          type: "mcq",
          opts: ["Dangerous", "Cautious", "Careful"],
          ans: "Dangerous",
        },
        {
          q: "Antonym of sharp:",
          type: "mcq",
          opts: ["Dull", "Pointed", "Keen"],
          ans: "Dull",
        },
        {
          q: "Antonym of shallow:",
          type: "mcq",
          opts: ["Deep", "Low", "Thin"],
          ans: "Deep",
        },
        {
          q: "Antonym of early:",
          type: "mcq",
          opts: ["Late", "Soon", "First"],
          ans: "Late",
        },
        {
          q: "Antonym of together:",
          type: "mcq",
          opts: ["Apart", "Close", "Near"],
          ans: "Apart",
        },
        {
          q: "Antonym of heavy:",
          type: "mcq",
          opts: ["Light", "Dense", "Weighted"],
          ans: "Light",
        },
      ];
      const L4 = [
        // Sentence Builder (text: exact sentence, lowercase match)
        {
          q: "Build the sentence:",
          hint: "[birds, sing, at, dawn]",
          type: "text",
          ans: "birds sing at dawn",
        },
        {
          q: "Build the sentence:",
          hint: "[we, walk, along, the, trail]",
          type: "text",
          ans: "we walk along the trail",
        },
        {
          q: "Build the sentence:",
          hint: "[the, river, flows, quietly]",
          type: "text",
          ans: "the river flows quietly",
        },
        {
          q: "Build the sentence:",
          hint: "[a, deer, ran, across, us]",
          type: "text",
          ans: "a deer ran across us",
        },
        {
          q: "Build the sentence:",
          hint: "[moss, covers, old, stones]",
          type: "text",
          ans: "moss covers old stones",
        },
        {
          q: "Build the sentence:",
          hint: "[they, rest, under, the, shade]",
          type: "text",
          ans: "they rest under the shade",
        },
        {
          q: "Build the sentence:",
          hint: "[we, listen, to, forest, sounds]",
          type: "text",
          ans: "we listen to forest sounds",
        },
        {
          q: "Build the sentence:",
          hint: "[the, path, turns, to, the, left]",
          type: "text",
          ans: "the path turns to the left",
        },
        {
          q: "Build the sentence:",
          hint: "[owls, hoot, in, the, night]",
          type: "text",
          ans: "owls hoot in the night",
        },
        {
          q: "Build the sentence:",
          hint: "[the, air, smells, like, rain]",
          type: "text",
          ans: "the air smells like rain",
        },
      ];
      const L5 = [
        // Fill the Gaps (MCQ)
        {
          q: "The fox jumped ___ the log.",
          type: "mcq",
          opts: ["over", "in", "behind"],
          ans: "over",
        },
        {
          q: "We rested ___ a tall tree.",
          type: "mcq",
          opts: ["under", "into", "onto"],
          ans: "under",
        },
        {
          q: "They ___ along the silent trail yesterday.",
          type: "mcq",
          opts: ["walked", "walk", "walking"],
          ans: "walked",
        },
        {
          q: "The river ___ quickly after the storm.",
          type: "mcq",
          opts: ["rose", "rises", "rising"],
          ans: "rose",
        },
        {
          q: "Leaves fell ___ the ground.",
          type: "mcq",
          opts: ["on", "into", "above"],
          ans: "on",
        },
        {
          q: "Birds ___ in the early morning.",
          type: "mcq",
          opts: ["sing", "sang", "sung"],
          ans: "sing",
        },
        {
          q: "We will ___ the camp before sunset.",
          type: "mcq",
          opts: ["reach", "reached", "reaching"],
          ans: "reach",
        },
        {
          q: "The guide pointed ___ the northern path.",
          type: "mcq",
          opts: ["to", "at", "on"],
          ans: "to",
        },
        {
          q: "He has ___ a shelter near the stream.",
          type: "mcq",
          opts: ["built", "build", "building"],
          ans: "built",
        },
        {
          q: "A group of hikers ___ arriving soon.",
          type: "mcq",
          opts: ["are", "is", "be"],
          ans: "are",
        },
      ];
      const L6 = [
        // Conversation with Animals (MCQ)
        {
          q: "Monkey: 'Banana?' — Your reply:",
          type: "mcq",
          opts: ["Yes, take it.", "I am a river.", "Blue is tall."],
          ans: "Yes, take it.",
        },
        {
          q: "Bird: 'Where are you going?' — Your reply:",
          type: "mcq",
          opts: [
            "To the forest trail.",
            "Because green softly.",
            "Seven runs sky.",
          ],
          ans: "To the forest trail.",
        },
        {
          q: "Deer: 'Is it safe ahead?' — Your reply:",
          type: "mcq",
          opts: [
            "Yes, we will move slowly.",
            "Orange sleeps music.",
            "Stone eats light.",
          ],
          ans: "Yes, we will move slowly.",
        },
        {
          q: "Owl: 'What time is it?' — Your reply:",
          type: "mcq",
          opts: [
            "It’s almost midnight.",
            "Triangle tastes quick.",
            "Run shines water.",
          ],
          ans: "It’s almost midnight.",
        },
        {
          q: "Bear: 'Are you lost?' — Your reply:",
          type: "mcq",
          opts: [
            "A little, could you help?",
            "Sand quiets roundly.",
            "Left bright after.",
          ],
          ans: "A little, could you help?",
        },
        {
          q: "Squirrel: 'Do you have nuts?' — Your reply:",
          type: "mcq",
          opts: ["I have a few.", "Cloud is taller.", "Sing fast big."],
          ans: "I have a few.",
        },
        {
          q: "Frog: 'Shall we cross now?' — Your reply:",
          type: "mcq",
          opts: [
            "Yes, the water is low.",
            "Blue runs music.",
            "Tall softly nine.",
          ],
          ans: "Yes, the water is low.",
        },
        {
          q: "Wolf: 'Stay close.' — Your reply:",
          type: "mcq",
          opts: [
            "I will follow you.",
            "I sleep the green.",
            "Circle makes taste.",
          ],
          ans: "I will follow you.",
        },
        {
          q: "Parrot: 'Repeat after me.' — Your reply:",
          type: "mcq",
          opts: [
            "Okay, I’m ready.",
            "Because quickly slow.",
            "Left cloud taste.",
          ],
          ans: "Okay, I’m ready.",
        },
        {
          q: "Rabbit: 'How far is the meadow?' — Your reply:",
          type: "mcq",
          opts: [
            "About ten minutes.",
            "Purple eats softly.",
            "Sooner round tallest.",
          ],
          ans: "About ten minutes.",
        },
      ];
      const L7 = [
        // Grammar Traps (text exact corrected sentence)
        {
          q: "Fix the sentence: 'He go to forest.'",
          type: "text",
          ans: "he goes to forest",
        },
        {
          q: "Fix: 'Birds sings at night.'",
          type: "text",
          ans: "birds sing at night",
        },
        {
          q: "Fix: 'We was walking fast.'",
          type: "text",
          ans: "we were walking fast",
        },
        {
          q: "Fix: 'There is many trees.'",
          type: "text",
          ans: "there are many trees",
        },
        {
          q: "Fix: 'She don't like rain.'",
          type: "text",
          ans: "she doesn't like rain",
        },
        {
          q: "Fix: 'The river are cold.'",
          type: "text",
          ans: "the river is cold",
        },
        {
          q: "Fix: 'They has found a cave.'",
          type: "text",
          ans: "they have found a cave",
        },
        {
          q: "Fix: 'I am agree with you.'",
          type: "text",
          ans: "i agree with you",
        },
        {
          q: "Fix: 'He runned too fast.'",
          type: "text",
          ans: "he ran too fast",
        },
        {
          q: "Fix: 'We didn't saw the owl.'",
          type: "text",
          ans: "we didn't see the owl",
        },
      ];
      const L8 = [
        // Story Builder (MCQ cloze)
        {
          q: "Story: We reached the ___ before sunset.",
          type: "mcq",
          opts: ["camp", "engine", "office"],
          ans: "camp",
        },
        {
          q: "Story: The guide ___ a safe route.",
          type: "mcq",
          opts: ["chose", "choose", "choosing"],
          ans: "chose",
        },
        {
          q: "Story: The wind was ___ but fresh.",
          type: "mcq",
          opts: ["cold", "older", "close"],
          ans: "cold",
        },
        {
          q: "Story: We ___ quietly and watched deer.",
          type: "mcq",
          opts: ["sat", "sits", "sitting"],
          ans: "sat",
        },
        {
          q: "Story: A light ___ fell through the trees.",
          type: "mcq",
          opts: ["rain", "train", "grain"],
          ans: "rain",
        },
        {
          q: "Story: We ___ our bottles at the stream.",
          type: "mcq",
          opts: ["filled", "fill", "filling"],
          ans: "filled",
        },
        {
          q: "Story: The map ___ on a wooden sign.",
          type: "mcq",
          opts: ["hung", "hanged", "hangs"],
          ans: "hung",
        },
        {
          q: "Story: We heard a ___ hoot twice.",
          type: "mcq",
          opts: ["distant", "distance", "distantly"],
          ans: "distant",
        },
        {
          q: "Story: The trail ___ to the left.",
          type: "mcq",
          opts: ["bends", "bend", "bended"],
          ans: "bends",
        },
        {
          q: "Story: At last we ___ the quiet meadow.",
          type: "mcq",
          opts: ["found", "find", "finding"],
          ans: "found",
        },
      ];
      const L9 = [
        // Listening Quest (speech synthesis + mcq meaning)
        {
          q: "Listen and choose meaning:",
          say: "We will cross the river after the rain stops.",
          type: "listen",
          opts: [
            "We will cross later.",
            "We already crossed.",
            "We cannot cross.",
          ],
          ans: "We will cross later.",
        },
        {
          q: "Listen and choose meaning:",
          say: "The path becomes narrow near the cliff.",
          type: "listen",
          opts: [
            "Path is tight there.",
            "Path is wide there.",
            "No path exists.",
          ],
          ans: "Path is tight there.",
        },
        {
          q: "Listen and choose meaning:",
          say: "Please keep your voice low in the forest.",
          type: "listen",
          opts: ["Speak softly.", "Sing loudly.", "Do not speak ever."],
          ans: "Speak softly.",
        },
        {
          q: "Listen and choose meaning:",
          say: "We spotted fresh footprints on the trail.",
          type: "listen",
          opts: ["We saw new tracks.", "We heard music.", "We lost the trail."],
          ans: "We saw new tracks.",
        },
        {
          q: "Listen and choose meaning:",
          say: "Set up the tent before it gets dark.",
          type: "listen",
          opts: ["Pitch tent now.", "Pack the tent.", "Avoid tents."],
          ans: "Pitch tent now.",
        },
        {
          q: "Listen and choose meaning:",
          say: "The ranger warned us about slippery rocks.",
          type: "listen",
          opts: ["Rocks may be slick.", "Rocks are warm.", "No rocks nearby."],
          ans: "Rocks may be slick.",
        },
        {
          q: "Listen and choose meaning:",
          say: "We followed the stream to find the lake.",
          type: "listen",
          opts: [
            "Stream led to lake.",
            "Lake followed stream.",
            "We left the stream.",
          ],
          ans: "Stream led to lake.",
        },
        {
          q: "Listen and choose meaning:",
          say: "Do not feed the wild animals.",
          type: "listen",
          opts: ["Avoid giving food.", "Give more food.", "Feed only birds."],
          ans: "Avoid giving food.",
        },
        {
          q: "Listen and choose meaning:",
          say: "The campsite is two kilometers ahead.",
          type: "listen",
          opts: ["It is close by.", "It is behind us.", "It is closed."],
          ans: "It is close by.",
        },
        {
          q: "Listen and choose meaning:",
          say: "Carry a flashlight in case of fog.",
          type: "listen",
          opts: ["Bring a light.", "Avoid lights.", "Fog means no light."],
          ans: "Bring a light.",
        },
      ];
      const L10 = [
        // Master Mixed (10 Q, each 5 XP)
        {
          q: "Synonym of rapid:",
          type: "mcq",
          opts: ["Quick", "Slow", "Late"],
          ans: "Quick",
        },
        {
          q: "Antonym of shallow:",
          type: "mcq",
          opts: ["Deep", "Thin", "Short"],
          ans: "Deep",
        },
        {
          q: "Build:",
          hint: "[we, must, cross, the, bridge]",
          type: "text",
          ans: "we must cross the bridge",
        },
        {
          q: "Fill: The guide ___ the safest route.",
          type: "mcq",
          opts: ["chose", "choose", "chooses"],
          ans: "chose",
        },
        {
          q: "Dialogue — Owl: 'Careful ahead.' Your reply:",
          type: "mcq",
          opts: [
            "Thanks, we’ll go slow.",
            "Cloud eats blue.",
            "Square runs softly.",
          ],
          ans: "Thanks, we’ll go slow.",
        },
        {
          q: "Fix: 'She don't hear the river.'",
          type: "text",
          ans: "she doesn't hear the river",
        },
        {
          q: "Listen:",
          say: "Pack enough water for the hike.",
          type: "listen",
          opts: ["Bring water.", "Throw water.", "Avoid water."],
          ans: "Bring water.",
        },
        {
          q: "Word Hunt:",
          hint: "CANOPY · SUBWAY · LAPTOP",
          type: "mcq",
          opts: ["Canopy", "Subway", "Laptop"],
          ans: "Canopy",
        },
        {
          q: "Fill: We rested ___ a wide oak.",
          type: "mcq",
          opts: ["under", "into", "onto"],
          ans: "under",
        },
        {
          q: "Build:",
          hint: "[the, forest, is, very, quiet]",
          type: "text",
          ans: "the forest is very quiet",
        },
      ];

      const bankByLevel = {
        1: L1,
        2: L2,
        3: L3,
        4: L4,
        5: L5,
        6: L6,
        7: L7,
        8: L8,
        9: L9,
        10: L10,
      };

      let deck = JSON.parse(JSON.stringify(bankByLevel[level]));
      deck = deck.slice(0, TOTAL_Q);

      function setText(id, html) {
        document.getElementById(id).innerHTML = html;
      }
      function enableSubmit(flag) {
        const b = document.getElementById("submitBtn");
        if (flag) {
          b.classList.remove("disabled");
          b.disabled = false;
        } else {
          b.classList.add("disabled");
          b.disabled = true;
        }
      }
      function setBar() {
        const pct = (current / TOTAL_Q) * 100;
        document.getElementById("bar").style.width = pct + "%";
        document.getElementById("qNow").textContent =
          current + 1 > TOTAL_Q ? TOTAL_Q : current + 1;
        document.getElementById("xpNow").textContent = score;
        document.getElementById("tries").textContent = tries;
      }

      function speak(t) {
        try {
          const u = new SpeechSynthesisUtterance(t);
          u.lang = "en-US";
          u.rate = 1;
          u.pitch = 1;
          u.volume = 1;
          speechSynthesis.cancel();
          speechSynthesis.speak(u);
        } catch (e) {}
      }

      function render() {
        if (current >= TOTAL_Q) {
          return finish();
        }
        lock = false;
        answered = false;
        selected = null;
        inputRef = null;
        tries = 3;
        setBar();
        const it = deck[current];
        let p = it.q;
        if (it.hint) {
          p += `<div class="mt-2 text-sm text-green-200/90">Hint: <span class="chip">${it.hint}</span></div>`;
        }
        if (it.say) {
          p += `<div class="mt-2"><button class="btn btn-ghost" id="sayBtn" type="button">🔊 Play</button></div>`;
        }
        setText("prompt", p);
        setText("sub", levelCaption());
        let ui = "";
        if (it.type === "mcq") {
          const opts = shuffle(it.opts.slice());
          ui =
            `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">` +
            opts
              .map(
                (o) =>
                  `<button class="option" data-v="${escapeHtml(
                    o
                  )}">${escapeHtml(o)}</button>`
              )
              .join("") +
            `</div>`;
        } else if (it.type === "text") {
          ui = `<div class="space-y-3"><input id="answer" type="text" class="w-full px-3 py-2 rounded outline-none" placeholder="type exact sentence"/><div class="text-xs text-green-100">Tip: lowercase, spaces only</div></div>`;
        } else if (it.type === "listen") {
          const opts = shuffle(it.opts.slice());
          ui =
            `<div class="flex flex-wrap gap-3">` +
            opts
              .map(
                (o) =>
                  `<button class="option" data-v="${escapeHtml(
                    o
                  )}">${escapeHtml(o)}</button>`
              )
              .join("") +
            `</div>`;
        }
        setText("ui", ui);
        setText("note", "");

        enableSubmit(false);

        document.querySelectorAll(".option").forEach((b) => {
          b.addEventListener("click", () => {
            if (lock) return;
            document
              .querySelectorAll(".option")
              .forEach((x) =>
                x.classList.remove("ring", "ring-2", "ring-emerald-400")
              );
            b.classList.add("ring", "ring-2", "ring-emerald-400");
            selected = b.getAttribute("data-v");
            answered = true;
            enableSubmit(true);
          });
        });

        const ans = document.getElementById("answer");
        if (ans) {
          inputRef = ans;
          ans.addEventListener("input", () => {
            answered = ans.value.trim().length > 0;
            enableSubmit(answered);
          });
        }

        const sayBtn = document.getElementById("sayBtn");
        if (sayBtn) {
          sayBtn.addEventListener("click", () => speak(it.say));
          setTimeout(() => speak(it.say), 150);
        }

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.onclick = submit;
      }

      function levelCaption() {
        switch (level) {
          case 1:
            return "Word Hunt 🪵 — pick the forest word.";
          case 2:
            return "Synonym Trail 🌿 — choose the synonym.";
          case 3:
            return "Antonym Quest 🍄 — choose the opposite.";
          case 4:
            return "Sentence Builder 🦜 — type exact sentence.";
          case 5:
            return "Fill the Gaps 🦋 — pick the correct word.";
          case 6:
            return "Conversation with Animals 🐒 — choose best reply.";
          case 7:
            return "Grammar Traps 🪶 — fix the sentence (lowercase).";
          case 8:
            return "Forest Story Builder 🌳 — complete the story.";
          case 9:
            return "Listening Quest 🎧 — listen and choose meaning.";
          case 10:
            return "Master: Escape the Forest Temple 🌟 — mixed tasks.";
        }
        return "";
      }

      function submit() {
        if (lock || !answered) return;
        lock = true;
        const it = deck[current];
        const correct = it.ans.toLowerCase().trim();
        let user = "";
        if (it.type === "mcq" || it.type === "listen") {
          user = (selected || "").toLowerCase().trim();
        } else if (it.type === "text") {
          user = (inputRef.value || "").toLowerCase().trim();
        }
        let ok = user === correct;
        if (ok) {
          score += perQuestionXP;
          flashNote("✅ Correct! +" + perQuestionXP + " XP", true);
          proceed();
        } else {
          tries--;
          if (tries > 0) {
            flashNote("❌ Wrong. Try again. Tries left: " + tries, false, true);
            lock = false;
          } else {
            flashNote(
              "➡️ Moving on. Correct answer: <span class='font-bold text-emerald-200'>" +
                escapeHtml(it.ans) +
                "</span>",
              false
            );
            proceed();
          }
        }
        setBar();
      }

      function proceed() {
        setTimeout(() => {
          current++;
          render();
        }, 550);
      }

      function flashNote(html, good = false, shake = false) {
        const n = document.getElementById("note");
        n.innerHTML = html;
        n.className = good
          ? "text-sm text-emerald-200"
          : "text-sm text-red-200";
        if (shake) {
          const container = document.querySelector(".glass");
          container.classList.remove("shake"); // restart
          void container.offsetWidth;
          container.classList.add("shake");
        }
      }

      function finish() {
        const passed = score >= GOAL_XP * 0.7; // >= 21 for normal, >=35 for master
        const title = passed ? "✅ Level Complete" : "🧭 Level Complete";
        const advice = passed
          ? "You met the requirement to unlock the next level."
          : "Score is below 70%. You can retry to unlock.";
        const html = `
        <div class="text-center space-y-4">
          <div class="text-2xl md:text-3xl font-extrabold text-green-100">${title}</div>
          <div class="text-green-200">Your XP: <span class="font-bold text-emerald-200">${score}</span> / <span>${GOAL_XP}</span></div>
          <div class="meter w-full max-w-md mx-auto"><span style="width:${Math.min(
            100,
            (score / GOAL_XP) * 100
          )}%"></span></div>
          <div class="text-sm text-green-100">${advice}</div>
          <div class="flex flex-wrap items-center justify-center gap-3 pt-2">
            <button class="btn" id="apply">Update Score</button>
            <button class="btn btn-ghost" id="ignore">Ignore Score</button>
            <button class="btn btn-ghost" id="retry">Replay Level</button>
            <a class="btn" href="forest-index.html">Back to Levels</a>
          </div>
        </div>
      `;
        setText("prompt", html);
        setText("sub", "");
        setText("ui", "");
        setText("note", "");
        document.getElementById("submitBtn").classList.add("hidden");
        document.getElementById("apply").onclick = () => {
          let profile = loadProfile();
          const idx = level - 1;
          if (profile.perLevelBest[idx] < score) {
            profile.perLevelBest[idx] = score;
          }
          if (level === 10 && score >= THRESHOLD_TO_UNLOCK) {
            profile.valleyUnlocked = true;
          }
          saveProfile(profile);
          location.href = "forest-index.html";
        };
        document.getElementById("ignore").onclick = () => {
          location.href = "forest-index.html";
        };
        document.getElementById("retry").onclick = () => {
          location.reload();
        };
      }

      function escapeHtml(s) {
        return s
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const btn = document.getElementById("submitBtn");
          if (!btn.disabled) submit();
        } else if (e.key === "Tab") {
          // focus cycle
        }
      });

      render();
    </script>
  </body>
</html>
