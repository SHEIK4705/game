<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fluency Quest X â€” Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Quicksand:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Quicksand", sans-serif;
        background: linear-gradient(120deg, #e0f7fa 0%, #f3e8ff 100%);
        min-height: 100vh;
        color: #1e293b;
      }
      .header-title {
        font-family: "Press Start 2P", cursive;
        text-shadow: 0 0 12px #34d399;
        letter-spacing: 2px;
      }
      .card {
        background: linear-gradient(120deg, #fff 70%, #e0f7fa 100%);
        border-radius: 1.2rem;
        box-shadow: 0 4px 24px rgba(52, 211, 153, 0.08);
        padding: 1.2rem;
        margin-bottom: 1.2rem;
      }
      @media (max-width: 640px) {
        .header-title {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="max-w-4xl mx-auto px-4 py-8">
      <!-- Header -->
      <header class="mb-8 text-center">
        <h1 class="header-title text-3xl md:text-4xl text-emerald-500 mb-2">
          ðŸ“Š Analytics & Progress
        </h1>
        <div class="text-lg text-slate-700 mb-2" id="greeting"></div>
        <div class="flex flex-wrap gap-4 justify-center mt-4">
          <a
            href="dashboard.html"
            class="bg-emerald-500 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-emerald-600 transition"
            >Back to Dashboard</a
          >
          <a
            href="game-index.html"
            class="bg-blue-500 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-blue-600 transition"
            >Play Game</a
          >
        </div>
      </header>

      <!-- Charts -->
      <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="text-lg font-bold text-emerald-600 mb-2">
            Accuracy by Region
          </h2>
          <canvas id="accuracyPie"></canvas>
        </div>
        <div class="card">
          <h2 class="text-lg font-bold text-emerald-600 mb-2">
            Consistency (Games Played)
          </h2>
          <canvas id="consistencyBar"></canvas>
        </div>
      </section>
      <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
          <h2 class="text-lg font-bold text-emerald-600 mb-2">
            XP Progress Over Time
          </h2>
          <canvas id="xpLine"></canvas>
        </div>
        <div class="card">
          <h2 class="text-lg font-bold text-emerald-600 mb-2">
            Recent Game Scores
          </h2>
          <canvas id="recentScoresBar"></canvas>
        </div>
      </section>

      <!-- Details -->
      <section class="mb-8">
        <div class="card">
          <h2 class="text-lg font-bold text-emerald-600 mb-2">Summary</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <span class="text-slate-500">Total Games Played:</span>
              <span class="font-bold text-blue-600" id="gamesPlayed">0</span>
            </div>
            <div>
              <span class="text-slate-500">Average Accuracy:</span>
              <span class="font-bold text-blue-600" id="avgAccuracy">0%</span>
            </div>
            <div>
              <span class="text-slate-500">Longest Streak:</span>
              <span class="font-bold text-blue-600" id="longestStreak">0</span>
            </div>
            <div>
              <span class="text-slate-500">Best Region:</span>
              <span class="font-bold text-blue-600" id="bestRegion">-</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      // Username greeting
      let username = localStorage.getItem("fqx_username") || "Adventurer";
      document.getElementById(
        "greeting"
      ).textContent = `Hello, ${username}! Hereâ€™s your progress analytics.`;

      // Region keys
      const REGION_KEYS = [
        { key: "fqx_progress_village_v1", name: "Village" },
        { key: "fqx_progress_valley_v1", name: "Valley" },
        { key: "fqx_forest_profile_v1", name: "Forest" },
        { key: "fqx_mountain_profile_v2", name: "Mountain" },
        { key: "fqx_ocean_profile_v1", name: "Ocean" },
        { key: "fqx_city_profile_v1", name: "City" },
      ];

      // Collect stats
      let regionStats = [];
      let gamesPlayed = 0;
      let longestStreak = 0;
      let avgAccuracy = 0;
      let bestRegion = "-";
      let bestXP = 0;
      let recentScores = [];
      let xpTimeline = [];

      REGION_KEYS.forEach((region) => {
        let raw = localStorage.getItem(region.key);
        let xp = 0,
          streak = 0,
          accuracy = 0,
          played = 0,
          scores = [];
        if (raw) {
          try {
            let p = JSON.parse(raw);
            if (Array.isArray(p.perLevelBest)) {
              xp = p.perLevelBest.reduce((a, b) => a + b, 0);
              played = p.perLevelBest.filter((x) => x > 0).length;
              accuracy = played
                ? Math.round(
                    (p.perLevelBest.filter((x) => x >= 7).length / played) * 100
                  )
                : 0;
              streak = p.streak || 0;
              scores = p.perLevelBest.slice(-5); // last 5 scores
              if (p.xpTimeline) xpTimeline = p.xpTimeline;
            }
          } catch (e) {}
        }
        gamesPlayed += played;
        if (streak > longestStreak) longestStreak = streak;
        if (xp > bestXP) {
          bestXP = xp;
          bestRegion = region.name;
        }
        regionStats.push({
          name: region.name,
          xp,
          streak,
          accuracy,
          played,
          scores,
        });
        recentScores = recentScores.concat(scores);
      });

      avgAccuracy = gamesPlayed
        ? Math.round(
            regionStats.reduce((a, r) => a + r.accuracy, 0) / regionStats.length
          )
        : 0;

      document.getElementById("gamesPlayed").textContent = gamesPlayed;
      document.getElementById("avgAccuracy").textContent = avgAccuracy + "%";
      document.getElementById("longestStreak").textContent = longestStreak;
      document.getElementById("bestRegion").textContent = bestRegion;

      // --- Chart.js Pie: Accuracy by Region ---
      const accuracyPie = new Chart(document.getElementById("accuracyPie"), {
        type: "pie",
        data: {
          labels: regionStats.map((r) => r.name),
          datasets: [
            {
              data: regionStats.map((r) => r.accuracy),
              backgroundColor: [
                "#34d399",
                "#2563eb",
                "#fbbf24",
                "#f43f5e",
                "#38bdf8",
                "#6366f1",
              ],
            },
          ],
        },
        options: {
          plugins: {
            legend: { position: "bottom" },
          },
        },
      });

      // --- Chart.js Bar: Consistency (Games Played) ---
      const consistencyBar = new Chart(
        document.getElementById("consistencyBar"),
        {
          type: "bar",
          data: {
            labels: regionStats.map((r) => r.name),
            datasets: [
              {
                label: "Games Played",
                data: regionStats.map((r) => r.played),
                backgroundColor: "#2563eb",
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
            plugins: {
              legend: { display: false },
            },
          },
        }
      );

      // --- Chart.js Line: XP Progress Over Time ---
      // If no timeline, simulate with region XP
      let xpLineLabels = xpTimeline.length
        ? xpTimeline.map((x, i) => `Game ${i + 1}`)
        : regionStats.map((r) => r.name);
      let xpLineData = xpTimeline.length
        ? xpTimeline
        : regionStats.map((r) => r.xp);

      const xpLine = new Chart(document.getElementById("xpLine"), {
        type: "line",
        data: {
          labels: xpLineLabels,
          datasets: [
            {
              label: "XP",
              data: xpLineData,
              borderColor: "#34d399",
              backgroundColor: "rgba(52,211,153,0.1)",
              tension: 0.3,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true },
          },
        },
      });

      // --- Chart.js Bar: Recent Game Scores ---
      const recentScoresBar = new Chart(
        document.getElementById("recentScoresBar"),
        {
          type: "bar",
          data: {
            labels: recentScores.map((_, i) => `Game ${i + 1}`),
            datasets: [
              {
                label: "Score",
                data: recentScores,
                backgroundColor: "#f59e42",
              },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
            },
            plugins: {
              legend: { display: false },
            },
          },
        }
      );
    </script>
  </body>
</html>
