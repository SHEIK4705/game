<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fluency Quest X â€” Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Quicksand:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Quicksand", sans-serif;
        background: linear-gradient(120deg, #e0f7fa 0%, #f3e8ff 100%);
        min-height: 100vh;
        color: #1e293b;
      }
      .header-title {
        font-family: "Press Start 2P", cursive;
        text-shadow: 0 0 12px #34d399;
        letter-spacing: 2px;
      }
      .rank-badge {
        font-family: "Press Start 2P", cursive;
        font-size: 1.2rem;
        padding: 0.5rem 1.2rem;
        border-radius: 1.2rem;
        color: #fff;
        background: linear-gradient(90deg, #34d399, #2563eb);
        box-shadow: 0 2px 12px rgba(52, 211, 153, 0.18);
        display: inline-block;
      }
      .rank-S {
        background: linear-gradient(90deg, #f59e42, #f43f5e);
      }
      .rank-A {
        background: linear-gradient(90deg, #34d399, #2563eb);
      }
      .rank-B {
        background: linear-gradient(90deg, #38bdf8, #6366f1);
      }
      .rank-C {
        background: linear-gradient(90deg, #fbbf24, #f59e42);
      }
      .rank-D {
        background: linear-gradient(90deg, #f87171, #fbbf24);
      }
      .rank-E {
        background: linear-gradient(90deg, #64748b, #94a3b8);
      }
      .region-card {
        background: linear-gradient(120deg, #fff 70%, #e0f7fa 100%);
        border-radius: 1.2rem;
        box-shadow: 0 4px 24px rgba(52, 211, 153, 0.08);
        padding: 1.2rem;
        margin-bottom: 1.2rem;
      }
      .progress-bar {
        height: 12px;
        border-radius: 999px;
        background: #e0e7ef;
        overflow: hidden;
      }
      .progress-bar-inner {
        height: 100%;
        background: linear-gradient(90deg, #34d399, #2563eb);
        transition: width 0.4s;
      }
      .level-badge {
        font-family: "Press Start 2P", cursive;
        font-size: 1rem;
        padding: 0.3rem 0.8rem;
        border-radius: 0.8rem;
        background: #2563eb;
        color: #fff;
        margin-right: 0.5rem;
        display: inline-block;
      }
      .stat-label {
        color: #64748b;
        font-size: 0.95rem;
      }
      .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2563eb;
      }
      @media (max-width: 640px) {
        .header-title {
          font-size: 1.2rem;
        }
        .rank-badge {
          font-size: 1rem;
          padding: 0.3rem 0.7rem;
        }
        .level-badge {
          font-size: 0.85rem;
          padding: 0.2rem 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="max-w-3xl mx-auto px-4 py-8">
      <!-- Header -->
      <header class="mb-8 text-center">
        <h1 class="header-title text-3xl md:text-4xl text-emerald-500 mb-2">
          ðŸŒŸ Fluency Quest X â€” Dashboard
        </h1>
        <div class="text-lg text-slate-700 mb-2" id="greeting"></div>
        <div>
          <span class="stat-label">Current Rank:</span>
          <span id="rankBadge" class="rank-badge">E</span>
        </div>
      </header>

      <!-- Main Stats -->
      <section class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="region-card">
          <div class="flex items-center justify-between mb-2">
            <span class="stat-label">Total XP</span>
            <span class="stat-value" id="totalXP">0</span>
          </div>
          <div class="progress-bar mb-2">
            <div id="xpBar" class="progress-bar-inner" style="width: 0%"></div>
          </div>
          <div class="flex items-center justify-between">
            <span class="stat-label">Levels Unlocked</span>
            <span class="stat-value" id="levelsUnlocked">0</span>
          </div>
        </div>
        <div class="region-card">
          <div class="flex items-center justify-between mb-2">
            <span class="stat-label">Current Level</span>
            <span class="level-badge" id="currentLevel">1</span>
          </div>
          <div class="flex items-center justify-between mb-2">
            <span class="stat-label">Next Level XP</span>
            <span class="stat-value" id="nextLevelXP">50</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="stat-label">Progress to Next Level</span>
            <span class="stat-value" id="progressToNext">0%</span>
          </div>
        </div>
      </section>

      <!-- Region Details -->
      <section class="mb-8">
        <h2 class="text-xl font-bold text-emerald-600 mb-4">Region Progress</h2>
        <div
          id="regionProgress"
          class="grid grid-cols-1 sm:grid-cols-2 gap-4"
        ></div>
      </section>

      <!-- Achievements & Details -->
      <section class="mb-8">
        <h2 class="text-xl font-bold text-emerald-600 mb-4">
          Achievements & Details
        </h2>
        <div class="region-card">
          <div class="flex flex-wrap gap-4 mb-2">
            <div>
              <span class="stat-label">Longest Streak:</span>
              <span class="stat-value" id="longestStreak">0</span>
            </div>
            <div>
              <span class="stat-label">Total Games Played:</span>
              <span class="stat-value" id="gamesPlayed">0</span>
            </div>
            <div>
              <span class="stat-label">Average Accuracy:</span>
              <span class="stat-value" id="avgAccuracy">0%</span>
            </div>
          </div>
          <div class="flex flex-wrap gap-4">
            <div>
              <span class="stat-label">Last Played:</span>
              <span class="stat-value" id="lastPlayed">-</span>
            </div>
            <div>
              <span class="stat-label">Best Region:</span>
              <span class="stat-value" id="bestRegion">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Links -->
      <section class="mb-8">
        <h2 class="text-xl font-bold text-emerald-600 mb-4">Quick Links</h2>
        <div class="flex flex-wrap gap-4">
          <a
            href="analytics.html"
            class="bg-emerald-500 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-emerald-600 transition"
            >View Analytics</a
          >
          <a
            href="game-index.html"
            class="bg-blue-500 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-blue-600 transition"
            >Play Game</a
          >
          <a
            href="#temporary-unavailable"
            class="bg-slate-500 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-slate-600 transition"
            >Profile</a
          >
        </div>
      </section>
    </div>

    <script>
      // --- Username greeting ---
      let username = localStorage.getItem("fqx_username") || "Adventurer";
      document.getElementById("greeting").textContent = `Welcome, ${username}!`;

      // --- Region keys ---
      const REGION_KEYS = [
        { key: "fqx_progress_village_v1", name: "Village" },
        { key: "fqx_progress_valley_v1", name: "Valley" },
        { key: "fqx_forest_profile_v1", name: "Forest" },
        { key: "fqx_mountain_profile_v2", name: "Mountain" },
        { key: "fqx_ocean_profile_v1", name: "Ocean" },
        { key: "fqx_city_profile_v1", name: "City" },
      ];

      // --- XP thresholds for levels ---
      const LEVELS_XP = [
        { level: 1, min: 0, max: 50 },
        { level: 2, min: 50, max: 100 },
        { level: 3, min: 100, max: 180 },
        { level: 4, min: 180, max: 260 },
        { level: 5, min: 260, max: 360 },
        { level: 6, min: 360, max: 480 },
        { level: 7, min: 480, max: 650 },
        { level: 8, min: 650, max: 850 },
        { level: 9, min: 850, max: 1100 },
        { level: 10, min: 1100, max: 1400 },
      ];

      // --- Ranks ---
      function getRank(xp) {
        if (xp >= 1100) return { rank: "S", label: "S Rank", class: "rank-S" };
        if (xp >= 850) return { rank: "A", label: "A Rank", class: "rank-A" };
        if (xp >= 650) return { rank: "B", label: "B Rank", class: "rank-B" };
        if (xp >= 360) return { rank: "C", label: "C Rank", class: "rank-C" };
        if (xp >= 180) return { rank: "D", label: "D Rank", class: "rank-D" };
        return { rank: "E", label: "E Rank", class: "rank-E" };
      }

      // --- Load region progress ---
      function loadRegionProgress() {
        let totalXP = 0;
        let levelsUnlocked = 0;
        let regionStats = [];
        let gamesPlayed = 0;
        let longestStreak = 0;
        let avgAccuracy = 0;
        let lastPlayed = "-";
        let bestRegion = "-";
        let bestXP = 0;

        REGION_KEYS.forEach((region) => {
          let raw = localStorage.getItem(region.key);
          let xp = 0,
            unlocked = 0,
            streak = 0,
            accuracy = 0,
            played = 0;
          if (raw) {
            try {
              let p = JSON.parse(raw);
              if (Array.isArray(p.perLevelBest)) {
                xp = p.perLevelBest.reduce((a, b) => a + b, 0);
                unlocked =
                  p.unlockedLevel !== undefined
                    ? p.unlockedLevel + 1
                    : p.unlocked
                    ? p.unlocked.filter(Boolean).length
                    : 0;
                streak = p.streak || 0;
                played = p.perLevelBest.filter((x) => x > 0).length;
                accuracy = played
                  ? Math.round(
                      (p.perLevelBest.filter((x) => x >= 7).length / played) *
                        100
                    )
                  : 0;
                if (p.lastPlayed) lastPlayed = p.lastPlayed;
              }
            } catch (e) {}
          }
          totalXP += xp;
          levelsUnlocked += unlocked;
          gamesPlayed += played;
          if (streak > longestStreak) longestStreak = streak;
          if (xp > bestXP) {
            bestXP = xp;
            bestRegion = region.name;
          }
          regionStats.push({
            name: region.name,
            xp,
            unlocked,
            streak,
            accuracy,
          });
        });

        avgAccuracy = gamesPlayed
          ? Math.round(
              regionStats.reduce((a, r) => a + r.accuracy, 0) /
                regionStats.length
            )
          : 0;

        // --- Fill main stats ---
        document.getElementById("totalXP").textContent = totalXP;
        document.getElementById("levelsUnlocked").textContent = levelsUnlocked;
        document.getElementById("longestStreak").textContent = longestStreak;
        document.getElementById("gamesPlayed").textContent = gamesPlayed;
        document.getElementById("avgAccuracy").textContent = avgAccuracy + "%";
        document.getElementById("lastPlayed").textContent = lastPlayed;
        document.getElementById("bestRegion").textContent = bestRegion;

        // --- Progress bar ---
        let maxXP = LEVELS_XP[LEVELS_XP.length - 1].max;
        let xpPct = Math.min(100, Math.round((totalXP / maxXP) * 100));
        document.getElementById("xpBar").style.width = xpPct + "%";

        // --- Level calculation ---
        let currentLevel = 1,
          nextLevelXP = LEVELS_XP[0].max;
        for (let i = 0; i < LEVELS_XP.length; i++) {
          if (totalXP >= LEVELS_XP[i].min && totalXP < LEVELS_XP[i].max) {
            currentLevel = LEVELS_XP[i].level;
            nextLevelXP = LEVELS_XP[i].max;
            break;
          }
          if (totalXP >= LEVELS_XP[LEVELS_XP.length - 1].max) {
            currentLevel = LEVELS_XP.length;
            nextLevelXP = maxXP;
          }
        }
        document.getElementById("currentLevel").textContent = currentLevel;
        document.getElementById("nextLevelXP").textContent = nextLevelXP;
        let progressToNext = Math.min(
          100,
          Math.round(
            ((totalXP - LEVELS_XP[currentLevel - 1].min) /
              (nextLevelXP - LEVELS_XP[currentLevel - 1].min)) *
              100
          )
        );
        document.getElementById("progressToNext").textContent =
          progressToNext + "%";

        // --- Rank badge ---
        const rank = getRank(totalXP);
        const rankBadge = document.getElementById("rankBadge");
        rankBadge.textContent = rank.label;
        rankBadge.className = "rank-badge " + rank.class;

        // --- Region progress cards ---
        const regionProgress = document.getElementById("regionProgress");
        regionProgress.innerHTML = "";
        regionStats.forEach((r) => {
          regionProgress.innerHTML += `
          <div class="region-card">
            <div class="flex items-center justify-between mb-2">
              <span class="font-bold text-emerald-700">${r.name}</span>
              <span class="level-badge">Levels: ${r.unlocked}</span>
            </div>
            <div class="flex items-center justify-between mb-2">
              <span class="stat-label">XP</span>
              <span class="stat-value">${r.xp}</span>
            </div>
            <div class="progress-bar mb-2">
              <div class="progress-bar-inner" style="width:${Math.min(
                100,
                Math.round((r.xp / nextLevelXP) * 100)
              )}%"></div>
            </div>
            <div class="flex items-center justify-between">
              <span class="stat-label">Streak</span>
              <span class="stat-value">${r.streak}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="stat-label">Accuracy</span>
              <span class="stat-value">${r.accuracy}%</span>
            </div>
          </div>
        `;
        });
      }

      // --- On load ---
      document.addEventListener("DOMContentLoaded", loadRegionProgress);
    </script>
  </body>
</html>
